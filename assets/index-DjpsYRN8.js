var v=Object.defineProperty;var S=(l,t,e)=>t in l?v(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var a=(l,t,e)=>S(l,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const h=class h{static getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}static getRandomChoice(t){if(t.length===0)throw new Error("Cannot choose from empty array");return t[Math.floor(Math.random()*t.length)]}static getSpeciesColors(t){const e=["#ff6b6b","#4ecdc4","#96ceb4","#feca57","#ff9ff3","#54a0ff","#00d2d3","#ff9f43"],i=t-e.length;for(;h.cachedColors.length<i;){const s=Math.floor(Math.random()*360),n=70+Math.floor(Math.random()*20),o=50+Math.floor(Math.random()*10),c=h.hslToHex(s,n,o);!e.includes(c)&&!h.cachedColors.includes(c)&&h.cachedColors.push(c)}return[...e,...h.cachedColors].slice(0,t)}static hslToHex(t,e,i){const s=i/100,n=e*Math.min(s,1-s)/100,o=c=>{const d=(c+t/30)%12,p=s-n*n*Math.max(Math.min(d-3,9-d,1),-1);return Math.round(255*p).toString(16).padStart(2,"0")};return`#${o(0)}${o(8)}${o(4)}`}static isValidInteger(t){return typeof t=="number"&&Number.isInteger(t)}static ensurePositiveInteger(t,e=1){return!this.isValidInteger(t)||t<=0?e:t}static getElement(t){const e=document.getElementById(t);if(!e)throw new Error(`Element with id ${t} not found`);return e}};a(h,"cachedColors",[]);let r=h;class C{constructor(t,e){a(this,"canvas");a(this,"ctx");a(this,"grid");a(this,"cellSize");a(this,"colors");a(this,"onCellClick");const i=r.getElement(t),s=i.getContext("2d");if(!s)throw new Error(`Missing context for canvas ${t}`);this.canvas=i,this.ctx=s,this.grid=e,this.cellSize=0,this.colors=[],this.updateCellSize(),this.setupEventListeners()}updateGrid(t){this.grid=t,this.updateCellSize()}updateCellSize(){this.cellSize=Math.min(this.canvas.width/this.grid.size,this.canvas.height/this.grid.size)}updateColors(){this.colors=["#000000",...r.getSpeciesColors(this.grid.speciesCount)]}render(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.grid.size;t++)if(this.grid.cells[t])for(let e=0;e<this.grid.size;e++){const i=this.grid.cells[t][e];i>0&&this.colors[i]&&(this.ctx.fillStyle=this.colors[i],this.ctx.fillRect(e*this.cellSize,t*this.cellSize,this.cellSize,this.cellSize))}this.grid.size<=70&&this.cellSize>=8&&this.drawGridLines()}drawGridLines(){this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=.5,this.ctx.beginPath();for(let t=0;t<=this.grid.size;t++){const e=t*this.cellSize;this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.grid.size*this.cellSize),this.ctx.moveTo(0,e),this.ctx.lineTo(this.grid.size*this.cellSize,e)}this.ctx.stroke()}setCellClickHandler(t){this.onCellClick=t}setupEventListeners(){let t=!1;const e=s=>{const n=this.canvas.getBoundingClientRect(),o=this.canvas.width/n.width,c=this.canvas.height/n.height,d=(s.clientX-n.left)*o,p=(s.clientY-n.top)*c,g=Math.floor(d/this.cellSize),f=Math.floor(p/this.cellSize);return{x:g,y:f}},i=s=>{const{x:n,y:o}=e(s),c=s.shiftKey;this.onCellClick&&this.onCellClick(n,o,c)};this.canvas.addEventListener("mousedown",s=>{s.preventDefault(),t=!0,i(s)}),this.canvas.addEventListener("mousemove",s=>{t&&i(s)}),this.canvas.addEventListener("mouseup",()=>{t=!1}),this.canvas.addEventListener("mouseleave",()=>{t=!1}),this.canvas.addEventListener("contextmenu",s=>{s.preventDefault()}),this.canvas.addEventListener("touchstart",s=>{s.preventDefault(),t=!0;const n=s.touches[0],o=new MouseEvent("mousedown",{clientX:n.clientX,clientY:n.clientY,shiftKey:!1});i(o)}),this.canvas.addEventListener("touchmove",s=>{if(!t)return;s.preventDefault();const n=s.touches[0],o=new MouseEvent("mousemove",{clientX:n.clientX,clientY:n.clientY});i(o)}),this.canvas.addEventListener("touchend",()=>{t=!1})}saveAsImage(t="game-of-immigration"){const e=document.createElement("canvas"),i=e.getContext("2d");if(!i){console.error("Failed to create temporary canvas context");return}e.width=this.canvas.width,e.height=this.canvas.height,i.fillStyle="#ffffff",i.fillRect(0,0,e.width,e.height),i.drawImage(this.canvas,0,0),e.toBlob(s=>{if(!s){console.error("Failed to create image blob");return}const n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=`${t}-${Date.now()}.png`,document.body.append(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)},"image/png")}}class E{constructor(t,e,i){a(this,"simulation");a(this,"grid");a(this,"canvas");a(this,"onGridSettingsChange");a(this,"onStatsUpdate");this.simulation=t,this.grid=e,this.canvas=i,this.setupEventListeners(),this.updateSpeciesColors()}updateGrid(t){this.grid=t,this.updateSpeciesColors()}setGridSettingsChangeHandler(t){this.onGridSettingsChange=t}setStatsUpdateHandler(t){this.onStatsUpdate=t}setupEventListeners(){r.getElement("playPauseBtn").addEventListener("click",()=>this.toggleSimulation()),r.getElement("stepBtn").addEventListener("click",()=>this.stepSimulation()),r.getElement("clearBtn").addEventListener("click",()=>this.clearGrid()),r.getElement("randomSeedBtn").addEventListener("click",()=>this.randomSeed());const t=r.getElement("fpsSlider"),e=r.getElement("fpsValue");t.addEventListener("input",i=>{const s=i.target,n=parseInt(s.value);isNaN(n)||(this.simulation.setFPS(n),e.textContent=n.toString())}),r.getElement("applyGridBtn").addEventListener("click",()=>this.applyGridSettings()),r.getElement("saveImageBtn").addEventListener("click",()=>{this.canvas.saveAsImage()})}toggleSimulation(){const t=r.getElement("playPauseBtn");this.simulation.running?(this.simulation.pause(),t.textContent="Start",t.classList.remove("active")):(this.simulation.start(),t.textContent="Pause",t.classList.add("active"))}stepSimulation(){this.simulation.step(),this.onStatsUpdate&&this.onStatsUpdate()}clearGrid(){this.grid.clear(),this.canvas.render(),this.onStatsUpdate&&this.onStatsUpdate()}randomSeed(){const t=r.getElement("speciesCount"),e=parseInt(t.value,10);isNaN(e)||(this.grid.speciesCount=e,this.updateSpeciesColors(),this.canvas.updateColors(),this.grid.randomSeed(.2),this.canvas.render(),this.onStatsUpdate&&this.onStatsUpdate())}applyGridSettings(){const t=r.getElement("gridSize"),e=r.getElement("speciesCount"),i=r.getElement("wraparound"),s=parseInt(t.value),n=parseInt(e.value),o=i.checked;if(isNaN(s)||isNaN(n)){console.error("Invalid grid settings");return}const c={gridSize:s,speciesCount:n,wraparound:o,fps:this.simulation.currentFPS};this.onGridSettingsChange&&this.onGridSettingsChange(c)}updateSpeciesColors(){const t=r.getElement("speciesColors");t.innerHTML="",r.getSpeciesColors(this.grid.speciesCount).forEach((s,n)=>{const o=document.createElement("div");o.classList="species-color",o.style.backgroundColor=s,o.title=`Species ${n+1}`,o.addEventListener("click",()=>{this.selectSpecies(n+1,o)}),t.appendChild(o)});const i=t.firstChild;i&&this.selectSpecies(1,i)}selectSpecies(t,e){document.querySelectorAll(".species-color").forEach(s=>s.classList.remove("selected")),e.classList.add("selected");const i=new CustomEvent("speciesSelected",{detail:{species:t}});document.dispatchEvent(i)}pauseSimulation(){if(this.simulation.running){this.simulation.pause();const t=r.getElement("playPauseBtn");t.textContent="Start",t.classList.remove("active")}}}class m{constructor(t,e,i=!0){a(this,"size");a(this,"speciesCount");a(this,"wraparound");a(this,"cells");a(this,"generation");this.size=r.ensurePositiveInteger(t,100),this.speciesCount=r.ensurePositiveInteger(e,2),this.wraparound=i,this.generation=0,this.cells=this.createEmptyGrid()}createEmptyGrid(){const t=[];for(let e=0;e<this.size;e++)t[e]=new Array(this.size).fill(0);return t}getCell(t,e){var i;if(this.wraparound)t=(t%this.size+this.size)%this.size,e=(e%this.size+this.size)%this.size;else if(t<0||t>=this.size||e<0||e>=this.size)return 0;return((i=this.cells[e])==null?void 0:i[t])??0}setCell(t,e,i){t>=0&&t<this.size&&e>=0&&e<this.size&&this.cells[e]&&(this.cells[e][t]=i)}getNeighbors(t,e){const i=[];for(let s=-1;s<=1;s++)for(let n=-1;n<=1;n++){if(n===0&&s===0)continue;const o=this.getCell(t+n,e+s);o>0&&i.push(o)}return i}getMajoritySpecies(t){if(t.length===0)return 1;const e={};t.forEach(n=>{e[n]=(e[n]||0)+1});let i=0,s=[];for(const[n,o]of Object.entries(e)){const c=parseInt(n);isNaN(c)||(o>i?(i=o,s=[c]):o===i&&s.push(c))}return s.length>0?r.getRandomChoice(s):1}step(){const t=this.createEmptyGrid();for(let e=0;e<this.size;e++)for(let i=0;i<this.size;i++){const s=this.getCell(i,e),n=this.getNeighbors(i,e),o=n.length;s>0?(o===2||o===3)&&(t[e][i]=s):o===3&&(t[e][i]=this.getMajoritySpecies(n))}this.cells=t,this.generation++}clear(){this.cells=this.createEmptyGrid(),this.generation=0}randomSeed(t=.3){this.clear();for(let e=0;e<this.size;e++)for(let i=0;i<this.size;i++)Math.random()<t&&(this.cells[e][i]=r.getRandomInt(1,this.speciesCount))}getTotalCells(){let t=0;for(let e=0;e<this.size;e++)for(let i=0;i<this.size;i++)this.cells[e][i]>0&&t++;return t}getSpeciesCounts(){const t={};for(let e=1;e<=this.speciesCount;e++)t[e]=0;for(let e=0;e<this.size;e++)for(let i=0;i<this.size;i++){const s=this.cells[e][i];s>0&&(t[s]=(t[s]||0)+1)}return t}}class w{constructor(t,e){a(this,"grid");a(this,"canvas");a(this,"isRunning");a(this,"fps");a(this,"lastFrameTime");a(this,"animationId");a(this,"onStep");a(this,"loop",()=>{if(!this.isRunning)return;const t=performance.now(),e=t-this.lastFrameTime,i=1e3/this.fps;e>=i&&(this.step(),this.lastFrameTime=t-e%i),this.animationId=requestAnimationFrame(this.loop)});this.canvas=e,this.grid=t,this.isRunning=!1,this.fps=10,this.lastFrameTime=0,this.animationId=null}get running(){return this.isRunning}get currentFPS(){return this.fps}setStepCallback(t){this.onStep=t}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.loop())}pause(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}step(){this.grid.step(),this.canvas.render(),this.onStep&&this.onStep()}setFPS(t){this.fps=t}updateGrid(t){this.grid=t}destroy(){this.pause()}}class y{constructor(){a(this,"grid");a(this,"canvas");a(this,"simulation");a(this,"controls");a(this,"selectedSpecies");a(this,"onSpeciesSelected");a(this,"onResize");a(this,"onKeydown");this.selectedSpecies=1,this.grid=new m(50,2,!0),this.canvas=new C("canvas",this.grid),this.simulation=new w(this.grid,this.canvas),this.controls=new E(this.simulation,this.grid,this.canvas),this.setupEventHandlers(),this.canvas.updateColors(),this.canvas.render(),this.updateStats(),this.grid.randomSeed(.2),this.canvas.render(),this.updateStats()}setupEventHandlers(){this.canvas.setCellClickHandler((t,e,i)=>{const s=i?0:this.selectedSpecies;this.grid.setCell(t,e,s),this.canvas.render(),this.updateStats()}),this.simulation.setStepCallback(()=>{this.updateStats()}),this.controls.setGridSettingsChangeHandler(t=>{this.updateGridSettings(t)}),this.controls.setStatsUpdateHandler(()=>{this.updateStats()}),this.onSpeciesSelected=t=>{const e=t;this.selectedSpecies=e.detail.species},this.onResize=()=>{setTimeout(()=>{this.canvas.render()},100)},this.onKeydown=t=>{switch(t.key.toLowerCase()){case" ":t.preventDefault();const e=r.getElement("playPauseBtn");e&&e.click();break;case"c":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.grid.clear(),this.canvas.render(),this.updateStats());break;case"r":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.grid.randomSeed(.2),this.canvas.render(),this.updateStats());break}},document.addEventListener("speciesSelected",this.onSpeciesSelected),window.addEventListener("resize",this.onResize),document.addEventListener("keydown",this.onKeydown)}updateGridSettings(t){this.controls.pauseSimulation(),this.grid=new m(t.gridSize,t.speciesCount,t.wraparound),this.canvas.updateGrid(this.grid),this.simulation.updateGrid(this.grid),this.controls.updateGrid(this.grid),this.simulation.setFPS(t.fps),this.canvas.render(),this.updateStats()}updateStats(){var s;const t=r.getElement("generation"),e=r.getElement("totalCells"),i=r.getElement("speciesCounts");if(t&&(t.textContent=this.grid.generation.toString()),e&&(e.textContent=this.grid.getTotalCells().toString()),i){const n=this.grid.getSpeciesCounts(),o=r.getSpeciesColors(this.grid.speciesCount);i.innerHTML="";for(let c=1;c<=this.grid.speciesCount;c++){const d=document.createElement("div");d.className="species-count";const p=document.createElement("div");p.className="count-color",p.style.backgroundColor=o[c-1];const g=document.createElement("span");g.textContent=((s=n[c])==null?void 0:s.toString())||"0",d.appendChild(p),d.appendChild(g),i.appendChild(d)}}}destroy(){this.simulation.destroy(),document.removeEventListener("speciesSelected",this.onSpeciesSelected),window.removeEventListener("resize",this.onResize),document.removeEventListener("keydown",this.onKeydown)}}let u=null;document.addEventListener("DOMContentLoaded",()=>{u=new y});window.addEventListener("beforeunload",()=>{u&&u.destroy()});document.addEventListener("visibilitychange",()=>{u&&u.simulation&&(document.hidden&&u.simulation.running?(u.simulation.pause(),window.autopaused=!0):!document.hidden&&window.autopaused&&(u.simulation.start(),window.autopaused=!1))});
